<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SIFTed | Cases</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <div class="noise"></div>
    {% from "_components.html" import site_nav %}
    {{ site_nav("cases") }}

    <header class="hero compact">
      <div class="hero-text">
        <p class="eyebrow">Casework</p>
        <h1>Cases</h1>
        <p class="lead">Track multiple workflows against the same image.</p>
      </div>
    </header>

    <main class="cases">
      <section class="case-form card">
        <h2>Create a case</h2>
        <form method="post" class="form-grid">
          <input type="hidden" id="caseImagePath" name="image_path" />
          <label class="input-stack">
            Case name
            <input
              id="caseName"
              name="name"
              type="text"
              placeholder="Case name"
            />
          </label>
          <label class="input-stack">
            Image path
            <div class="input-row">
              <input
                id="caseImagePathDisplay"
                type="text"
                placeholder="/cases/your-image.dd"
              />
              <button class="ghost" type="button" id="caseBrowse">Browse</button>
            </div>
          </label>
          <label class="input-stack">
            Summary (optional)
            <input name="summary" type="text" placeholder="Optional notes" />
          </label>
          <button class="action" type="submit">Create case</button>
        </form>
        <div class="case-form-footer">
          <div class="case-help">
            <h3>Quick tips</h3>
            <ul class="case-help-list">
              <li>Use a clear case name and keep summaries short.</li>
              <li>Point to a stable evidence path (disk image, memory, or artifacts).</li>
              <li>Re-use cases to keep related runs together.</li>
            </ul>
          </div>
          {% if cases %}
            <div class="case-recent">
              <h3>Recent cases</h3>
              <div class="case-recent-list">
                {% for case in cases|reverse %}
                  {% if loop.index <= 3 %}
                    <a class="case-recent-link" href="#case-{{ case.id }}">{{ case.name }}</a>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </section>

      <section class="case-list">
        {% if cases %}
          {% for case in cases|reverse %}
            <article class="case-card collapsible" data-case="{{ case.id }}" id="case-{{ case.id }}">
              <button class="case-toggle" type="button" aria-expanded="false">
                <div class="case-toggle-main">
                  <h3>{{ case.name }}</h3>
                  <p class="case-path">{{ case.image_path or "No image path yet" }}</p>
                </div>
                <div class="case-toggle-cta">
                  <span class="case-toggle-label" data-closed-label="View details" data-open-label="Hide details">
                    View details
                  </span>
                  <span class="toggle-icon">+</span>
                </div>
              </button>
              <div class="case-body">
                <div class="case-meta">
                  <span class="case-meta-pill">ID {{ case.id[:8] }}</span>
                  <span class="case-meta-pill">Created {{ case.created_at }}</span>
                  {% if case.file_hash %}
                    <span class="case-meta-pill case-hash">SHA-256 {{ case.file_hash }}</span>
                  {% elif case.hash_error %}
                    <span class="case-meta-pill case-hash warn">{{ case.hash_error }}</span>
                  {% endif %}
                </div>
                {% if case.summary %}
                  <p class="case-summary">{{ case.summary }}</p>
                {% endif %}
                {% if runs_by_case.get(case.id) %}
                  <div class="case-runs">
                    {% for group in runs_by_case.get(case.id) %}
                      <div class="run-group">
                        <button class="run-group-toggle" type="button" aria-expanded="false">
                          <div class="run-group-info">
                            <span class="run-group-title">{{ group.tool|title }}</span>
                            <span class="run-group-count">{{ group.runs|length }} runs</span>
                          </div>
                          <span class="run-group-label" data-closed-label="View runs" data-open-label="Hide runs">
                            View runs
                          </span>
                          <span class="run-group-icon">+</span>
                        </button>
                        <div class="run-group-body">
                          {% for run in group.runs %}
                            <div class="run-item">
                              <div class="run-meta">
                                <span class="run-status-pill" data-status="{{ (run.status or 'logged')|lower }}">
                                  {{ run.status or "logged" }}
                                </span>
                                <span class="run-time">{{ run.created_at }}</span>
                              </div>
                              {% if run.failed_plugins %}
                                <div class="run-failures">
                                  <span class="run-failures-label">Failed plugins</span>
                                  <div class="run-failures-list">
                                    {% for plugin in run.failed_plugins %}
                                      <span class="run-failure-chip">{{ plugin }}</span>
                                    {% endfor %}
                                  </div>
                                </div>
                              {% endif %}
                              {% if run.result_files %}
                                <div class="run-results">
                                  <button class="run-results-toggle" type="button" aria-expanded="false">
                                    <span class="run-results-label" data-closed-label="View results" data-open-label="Hide results">
                                      View results
                                    </span>
                                    <span class="run-results-icon">+</span>
                                  </button>
                                  <div class="run-results-body">
                                    <div class="run-results-links">
                                      {% for item in run.result_files %}
                                        <a class="run-result-link" href="{{ url_for('view_file') }}?path={{ item.path|urlencode }}">{{ item.name }}</a>
                                      {% endfor %}
                                    </div>
                                    {% if run.result_truncated %}
                                      <span class="run-results-note">Showing first {{ run.result_files|length }} files.</span>
                                    {% endif %}
                                  </div>
                                </div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <p class="case-empty">No runs yet.</p>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        {% else %}
          <p class="case-empty">No cases yet. Create one to get started.</p>
        {% endif %}
      </section>
    </main>

    {% from "_components.html" import browse_drawer %}
    {{ browse_drawer() }}
    {% from "_components.html" import glossary_sidebar, guides_sidebar, active_jobs_drawer %}
    {{ glossary_sidebar() }}
    {{ guides_sidebar() }}
    {{ active_jobs_drawer() }}
    <footer></footer>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script src="{{ url_for('static', filename='glossary.js') }}"></script>
    <script src="{{ url_for('static', filename='cases.js') }}"></script>
    <script src="{{ url_for('static', filename='guides-sidebar.js') }}"></script>
  </body>
</html>
